package me.projectbw.BWTelegramNotify;

import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.event.server.ServerLoadEvent;
import org.bukkit.event.server.ServerShutdownEvent;  // –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
import org.bukkit.plugin.java.JavaPlugin;
import org.simpleyaml.configuration.file.YamlConfiguration;

import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.logging.Logger;

public class PaperMain extends JavaPlugin implements Listener {
    private YamlConfiguration config;
    private Logger logger;
    private static final String GITHUB_API_URL = "https://api.github.com/repos/bwproject/BWTelegramNotify/releases/latest";
    private static final double TPS_THRESHOLD = 15.0;

    @Override
    public void onEnable() {
        this.logger = getLogger();
        loadConfig();

        // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
        String message = config.getString("messages.server_started", "‚úÖ **–°–µ—Ä–≤–µ—Ä {server} –∑–∞–ø—É—â–µ–Ω!**")
                .replace("{server}", getServerName());
        logger.info(message);

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è
        getServer().getPluginManager().registerEvents(this, this);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ TPS
        startTPSMonitoring();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        checkForUpdates();

        logger.info("BWTelegramNotify —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
    }

    @Override
    public void onDisable() {
        String message = config.getString("messages.server_stopped", "‚õî **–°–µ—Ä–≤–µ—Ä {server} –≤—ã–∫–ª—é—á–µ–Ω!**")
                .replace("{server}", getServerName());
        logger.info(message);
        logger.info("BWTelegramNotify –æ—Ç–∫–ª—é—á–µ–Ω.");
    }

    @EventHandler
    public void onPlayerJoin(PlayerJoinEvent event) {
        String message = config.getString("messages.player_join", "üîµ **–ò–≥—Ä–æ–∫ {player} –∑–∞—à–µ–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä {server}**")
                .replace("{player}", event.getPlayer().getName())
                .replace("{server}", getServerName());
        logger.info(message);
    }

    @EventHandler
    public void onPlayerQuit(PlayerQuitEvent event) {
        String message = config.getString("messages.player_quit", "‚ö™ **–ò–≥—Ä–æ–∫ {player} –≤—ã—à–µ–ª —Å —Å–µ—Ä–≤–µ—Ä–∞ {server}**")
                .replace("{player}", event.getPlayer().getName())
                .replace("{server}", getServerName());
        logger.info(message);
    }

    @EventHandler
    public void onServerLoad(ServerLoadEvent event) {
        checkTPS();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
    @EventHandler
    public void onServerStop(ServerShutdownEvent event) {  // –ó–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
        String message = config.getString("messages.server_stopped", "‚õî **–°–µ—Ä–≤–µ—Ä {server} –≤—ã–∫–ª—é—á–µ–Ω!**")
                .replace("{server}", getServerName());
        logger.info(message);
    }

    private void loadConfig() {
        // –í–∞—à –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    }

    private String getServerName() {
        return Bukkit.getServer().getName();
    }

    private void checkTPS() {
        double tps = Bukkit.getServer().getTPS()[0];
        if (tps < TPS_THRESHOLD) {
            String message = "–í–Ω–∏–º–∞–Ω–∏–µ: –Ω–∏–∑–∫–∏–π TPS: " + tps;
            Bukkit.getLogger().warning(message);
        }
    }

    // –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ TPS
    private void startTPSMonitoring() {
        new BukkitRunnable() {
            @Override
            public void run() {
                double tps = Bukkit.getServer().getTPS()[0];
                if (tps < TPS_THRESHOLD) {
                    String message = "–í–Ω–∏–º–∞–Ω–∏–µ: –Ω–∏–∑–∫–∏–π TPS: " + tps;
                    Bukkit.getLogger().warning(message);
                }
            }
        }.runTaskTimerAsynchronously(this, 0L, 1200L);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–ª–∞–≥–∏–Ω–∞
    public void checkForUpdates() {
        try {
            HttpURLConnection connection = (HttpURLConnection) new URL(GITHUB_API_URL).openConnection();
            connection.setRequestMethod("GET");
            connection.setRequestProperty("Accept", "application/vnd.github.v3+json");

            BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream()));
            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            reader.close();

            JSONObject jsonResponse = new JSONObject(response.toString());
            String latestVersion = jsonResponse.getString("tag_name");

            JSONArray assets = jsonResponse.getJSONArray("assets");
            String downloadUrl = null;

            // –ò—â–µ–º —Ñ–∞–π–ª —Å "BWTelegramNotify-Paper" –≤ –∏–º–µ–Ω–∏
            for (int i = 0; i < assets.length(); i++) {
                JSONObject asset = assets.getJSONObject(i);
                String assetName = asset.getString("name");
                if (assetName.startsWith("BWTelegramNotify-Paper")) {
                    downloadUrl = asset.getString("browser_download_url");
                    break;
                }
            }

            if (downloadUrl == null) {
                System.out.println("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏.");
                return;
            }

            System.out.println("–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞: " + latestVersion);
            downloadNewVersion(downloadUrl, latestVersion);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void downloadNewVersion(String downloadUrl, String latestVersion) {
        try {
            System.out.println("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞: " + downloadUrl);
            URL url = new URL(downloadUrl);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");

            InputStream inputStream = connection.getInputStream();
            FileOutputStream outputStream = new FileOutputStream("plugins/BWTelegramNotify-Paper.jar");

            byte[] buffer = new byte[4096];
            int bytesRead;
            while ((bytesRead = inputStream.read(buffer)) != -1) {
                outputStream.write(buffer, 0, bytesRead);
            }

            inputStream.close();
            outputStream.close();

            System.out.println("–ü–ª–∞–≥–∏–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –≤–µ—Ä—Å–∏–∏ " + latestVersion + "!");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}